<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M.I.C.H.E.L</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #000000; --panel: rgba(12, 18, 28, 0.95); --border: #334155;
            --text: #e2e8f0; --dim: #94a3b8; --accent: #3b82f6; --alert: #ef4444; --warn: #f97316; --good: #22c55e;
            --nav-height: 70px;
        }

        /* === LIGHT MODE (DAY) === */
        body.day-mode { 
            --bg: #f1f5f9;           
            --panel: #ffffff;        
            --border: #cbd5e1;       
            --text: #0f172a;         
            --dim: #475569;          
            --accent: #2563eb;       
        }
        body.day-mode #bottom-nav { background: #ffffff; border-top: 1px solid #cbd5e1; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        body.day-mode .data-card { box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        body.day-mode .val-huge, body.day-mode .val-big, body.day-mode .hud-val, body.day-mode #turn-text { color: #0f172a !important; }
        body.day-mode #nav-hud { background: rgba(255, 255, 255, 0.95); border: 2px solid var(--accent); }

        /* ZUSATZ F√úR HOHEN KONTRAST (TAG) */
        body.day-mode .leaflet-tile-pane { filter: contrast(110%); } /* Leichter Kontrast-Boost f√ºr Esri Map */
        body.day-mode path.leaflet-interactive { stroke-opacity: 1 !important; }

        /* === NIGHT MODE (RED) === */
        body.night-mode { --bg: #000; --panel: #1a0000; --border: #500; --text: #f00; --dim: #800; --accent: #f00; --alert: #f00; }
        body.night-mode .leaflet-layer { filter: grayscale(100%) sepia(100%) hue-rotate(-50deg) saturate(600%) brightness(0.5) contrast(1.2); }

        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow: hidden; }

        /* VIEW & MAP */
        .view-section { position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - var(--nav-height)); display: none; overflow-y: auto; padding-bottom: 20px; }
        .view-section.active { display: block; }
        #view-map { padding: 0; overflow: hidden; }
        #map-wrapper { width: 100%; height: 100%; overflow: hidden; background: #050505; }
        #map { width: 100%; height: 100%; transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }

        /* HUD */
        #nav-hud {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); border: 2px solid var(--accent); border-radius: 8px;
            padding: 8px 15px; z-index: 4000; text-align: center; width: 92%; max-width: 400px;
            display: none; box-shadow: 0 4px 20px rgba(0,0,0,0.8); pointer-events: none;
        }
        .hud-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; margin-bottom: 8px; }
        .hud-val { font-family: 'JetBrains Mono'; font-weight: 700; color: #fff; font-size: 1.1em; }
        .label { font-size: 0.6em; color: var(--dim); font-weight: bold; text-transform: uppercase; }

        /* TURN INSTRUCTION */
        #turn-box {
            background: #1e293b; border-radius: 4px; padding: 5px; 
            font-family: 'JetBrains Mono'; font-weight: bold; color: #fff; font-size: 1.0em;
            border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        body.day-mode #turn-box { background: #f1f5f9; border-color: #94a3b8; }

        /* CONTROLS (BUTTONS) */
        .fab-container { position: absolute; bottom: 20px; right: 20px; z-index: 4000; display: flex; flex-direction: column; gap: 12px; align-items: flex-end; }
        
        .btn-fab {
            width: 50px; height: 50px; border-radius: 50%; border: 1px solid var(--border);
            background: rgba(10, 15, 20, 0.9); color: #fff; font-size: 1.6em; cursor: pointer;
            display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: all 0.2s; pointer-events: auto;
        }

        /* --- DAY MODE BUTTONS (HIGH CONTRAST FIX) --- */
        /* Inaktiv: Weiss mit grauen Rand */
        body.day-mode .btn-fab { 
            background: #ffffff; 
            color: #334155; 
            border: 2px solid #94a3b8; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        
        /* Aktiv: Tiefes Blau mit weissem Icon (Invertiert) */
        body.day-mode .btn-fab.active { 
            background: #2563eb; 
            border-color: #1e3a8a; /* Dunklerer Rand */
            box-shadow: 0 0 0 2px rgba(255,255,255,0.8), 0 4px 15px rgba(37, 99, 235, 0.6); /* Doppel-Ring Effekt */
            color: #ffffff !important;
            transform: scale(1.05); /* Leicht vergr√∂√üern */
        }
        /* ------------------------------------------- */

        .btn-fab.active { background: var(--accent); border-color: #fff; box-shadow: 0 0 15px var(--accent); color: #fff; }
        .btn-fab:active { transform: scale(0.95); }
        
        #btn-sar-main {
            width: auto; padding: 0 20px; border-radius: 25px; font-weight: 800; font-size: 0.9em;
            background: var(--alert); border-color: #fff; text-transform: uppercase; color: #fff;
        }
        
        #btn-stop-nav {
            background: var(--alert); color: white; border: none; padding: 8px 10px; 
            margin-top: 8px; width: 100%; border-radius: 4px; font-weight: bold; cursor: pointer; pointer-events: auto;
        }

        /* INFO CARDS */
        .info-container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .data-card { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 15px; padding: 15px; }
        .card-header { font-size: 0.8em; font-weight: 800; color: var(--dim); border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 10px; display:flex; justify-content:space-between; }
        .val-huge { font-family: 'JetBrains Mono'; font-size: 2.2em; font-weight: 700; color: #fff; }
        .val-big { font-family: 'JetBrains Mono'; font-size: 1.3em; font-weight: 700; color: #fff; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-3 { display: flex; justify-content: space-around; text-align: center; }

        /* BOTTOM NAV */
        #bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: #0f172a; border-top: 1px solid var(--border); z-index: 6000;
            display: flex; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { color: var(--dim); text-align: center; font-size: 0.7em; font-weight: bold; width: 33%; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 1.8em; margin-bottom: 4px; display: block; }

        /* SAR MODAL */
        #sar-modal { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--panel); border: 2px solid var(--alert); padding: 20px; z-index: 7000; border-radius: 8px; text-align: center; width: 80%; max-width: 300px; }
        #sar-modal input { background: #000; border: 1px solid var(--border); color: #fff; padding: 10px; width: 80px; text-align: center; font-size: 1.2em; margin: 15px 0; }
        body.day-mode #sar-modal input { background: #fff; color: #000; }
        .modal-btn { background: var(--border); border: none; padding: 12px; color: white; font-weight: bold; width: 100%; margin-top: 5px; border-radius: 4px; }
        .modal-btn.primary { background: var(--alert); }

        .boat-icon { font-size: 26px; color: #facc15; text-shadow: 0 0 10px #000; transition: transform 0.1s linear; }
        body.day-mode .boat-icon { color: #2563eb; text-shadow: 0 0 5px #fff; }

        /* === SYSTEM NACHRICHTEN (Ersatz f√ºr Alert) === */
        #sys-msg-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 9000;
            justify-content: center; align-items: center; backdrop-filter: blur(2px);
        }
        .sys-msg-box {
            background: var(--panel); border: 2px solid var(--accent);
            padding: 25px; border-radius: 12px; text-align: center;
            width: 80%; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        body.day-mode .sys-msg-box { background: #ffffff; color: #0f172a; border-color: var(--accent); }
        
        .sys-msg-btn {
            background: var(--accent); color: #fff; border: none;
            padding: 12px 25px; border-radius: 6px; font-weight: bold;
            font-size: 1em; margin-top: 20px; width: 100%;
        }

    </style>
</head>
<body>
    
    <div id="nav-hud">
        <div class="hud-grid">
            <div><span class="hud-val" id="hud-sog">--</span><br><span class="label">KN</span></div>
            <div><span class="hud-val" id="hud-cog">--</span><br><span class="label">COG</span></div>
            <div><span class="hud-val" id="hud-dist">--</span><br><span class="label">NM</span></div>
            <div><span class="hud-val" id="hud-eta">--</span><br><span class="label">ETA</span></div>
        </div>
        <div id="turn-box">
            <span style="color:var(--accent); margin-right:5px;" id="turn-dist">-- m</span>
            <span id="turn-arrow">‚¨ÜÔ∏è</span> 
            <span style="color:#fff" id="turn-text">KURS HALTEN</span>
        </div>
        <button id="btn-stop-nav" onclick="stopNavigation()">ROUTING BEENDEN</button>
    </div>

    <div id="view-map" class="view-section active">
        <div id="map-wrapper"><div id="map"></div></div>
        
        <div class="fab-container">
            <div id="btn-night" class="btn-fab" onclick="toggleNight()">üåô</div>
            <div id="btn-full" class="btn-fab" onclick="toggleFullscreen()">‚õ∂</div>
            <div id="btn-loc" class="btn-fab" onclick="locateUser()">üìç</div>
            <div id="btn-center" class="btn-fab active" onclick="toggleAutoCenter()">üéØ</div>
            <div id="btn-flow" class="btn-fab active" onclick="toggleFlow()">üåä</div>
            <div id="btn-nav" class="btn-fab" onclick="toggleNavMode()">‚öì</div>
            <div id="btn-sar-main" class="btn-fab" onclick="handleSarClick()">üëÆ PERSON IM WASSER</div>
        </div>
    </div>

    <div id="view-hydro" class="view-section">
        <div class="info-container">
            <div class="data-card">
                <div class="card-header">PEGEL ST. PAULI <span id="status-dot">‚óè INIT</span></div>
                <div style="text-align: center; margin-bottom: 15px;">
                    <span class="label">AKTUELLE TIDE</span>
                    <div id="val-tide-status" class="val-huge">--</div>
                    <div id="val-tide-sub" style="color: var(--dim);">Warte auf Daten...</div>
                </div>
                <div class="grid-2">
                    <div><span class="label">WASSERSTAND</span><span id="val-pegel" class="val-big">--</span></div>
                    <div><span class="label">TENDENZ</span><span id="val-trend" class="val-big">--</span></div>
                </div>
                <div style="margin-top:15px; padding-top:10px; border-top:1px solid var(--border); text-align:center;">
                    <span class="label">STR√ñMUNG (kalkuliert)</span>
                    <span id="val-flow" class="val-big">-- m/s</span>
                </div>
            </div>
            <div class="data-card" style="border-left: 3px solid var(--accent);">
                <div class="card-header">GEZEITEN VORSCHAU</div>
                <div class="grid-2">
                    <div><span class="label">N√ÑCHSTES HW</span><span id="next-hw" class="val-big" style="color:#fbbf24">--:--</span></div>
                    <div><span class="label">N√ÑCHSTES NW</span><span id="next-nw" class="val-big" style="color:#22d3ee">--:--</span></div>
                </div>
                <div id="tide-count" style="margin-top:10px; text-align:center; color:var(--dim); font-size:0.9em;"></div>
            </div>
        </div>
    </div>

    <div id="view-status" class="view-section">
        <div class="info-container">
            <div class="data-card">
                <div class="card-header">WETTER LAGE</div>
                <div class="grid-3">
                    <div><span class="label">LUFT</span><span id="val-air" class="val-big">--¬∞</span></div>
                    <div><span class="label">WASSER</span><span id="val-water" class="val-big">--¬∞</span></div>
                    <div><span class="label">WIND</span><span id="val-wind" class="val-big">--</span></div>
                </div>
                <div id="hypo-warn" style="text-align:center; margin-top:15px; font-weight:bold; color:var(--warn);"></div>
            </div>
            
            <div class="data-card">
                <div class="card-header">TAGESLICHT</div>
                <div class="grid-2">
                    <div><span class="label">AUFGANG</span><span id="val-sunrise" class="val-big">--:--</span></div>
                    <div style="text-align:right;"><span class="label">UNTERGANG</span><span id="val-sunset" class="val-big">--:--</span></div>
                </div>
            </div>

            <div class="data-card">
                <div class="card-header">SCHLEUSE TIEFSTACK</div>
                <div style="text-align:center;">
                    <div id="ts-status" class="val-huge">--</div>
                    <div id="ts-reason" style="color:var(--dim); margin-top:5px;">Pr√ºfung...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="bottom-nav">
        <div class="nav-item active" onclick="switchView('map', this)"><span class="nav-icon">üó∫Ô∏è</span>KARTE</div>
        <div class="nav-item" onclick="switchView('hydro', this)"><span class="nav-icon">üåä</span>HYDRO</div>
        <div class="nav-item" onclick="switchView('status', this)"><span class="nav-icon">‚öôÔ∏è</span>STATUS</div>
    </div>

    <div id="sar-modal">
        <h3>EINSATZ START</h3>
        <p>Minuten seit Sichtung:</p>
        <input type="number" id="sar-min" value="0" min="0">
        <button class="modal-btn primary" onclick="startSar()">BERECHNEN</button>
        <button class="modal-btn" onclick="closeModal()">ABBRUCH</button>
    </div>

    <div id="sys-msg-overlay">
        <div class="sys-msg-box">
            <h3 id="sys-msg-title" style="margin-top:0">HINWEIS</h3>
            <p id="sys-msg-text" style="font-size: 1.1em; line-height: 1.4;">--</p>
            <button class="sys-msg-btn" onclick="closeSysMsg()">VERSTANDEN</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.js"></script>
    <script src="https://unpkg.com/leaflet-geometryutil@0.9.3/src/leaflet.geometryutil.js"></script>

    <script>
    // =============================================================
    // 1. DATEN PLATZHALTER 
    // =============================================================
    
    // !!! HIER DEINE waypoints VARIABLE EINF√úGEN !!!
    const waypoints = {"w1": [53.52801, 10.03734], "w2": [53.5304, 10.03002], "w3": [53.5317, 10.0265], "w4": [53.53656, 10.00243], "w5": [53.53711, 9.99526], "w6": [53.53766, 9.99067], "w7": [53.52884, 10.04153], "w8": [53.5291, 10.0494], "w9": [53.52856, 10.05745], "w10": [53.52422, 10.06279], "w11": [53.51959, 10.06524], "w12": [53.51467, 10.06579], "w13": [53.51513, 10.06979], "w14": [53.52527, 10.06702], "w15": [53.52485, 10.0712], "w16": [53.53004, 10.08307], "w17": [53.52087, 10.07972], "w18": [53.51699, 10.08603], "w19": [53.52625, 10.0841], "w20": [53.52392, 10.08972], "w21": [53.52684, 10.10075], "w22": [53.52613, 10.10568], "w23": [53.52846, 10.06069], "w24": [53.52836, 10.06597], "w25": [53.52925, 10.0686], "w26": [53.53069, 10.0697], "w27": [53.53491, 10.07251], "w28": [53.53365, 10.08081], "w29": [53.53212, 10.08918], "w30": [53.53026, 10.09901], "w31": [53.5286, 10.10789], "w32": [53.53694, 10.07384], "w33": [53.53725, 10.07476], "w34": [53.53795, 10.07777], "w35": [53.53879, 10.0803], "w36": [53.53976, 10.08279], "w37": [53.53996, 10.08579], "w38": [53.53921, 10.08882], "w39": [53.53778, 10.09271], "w40": [53.53763, 10.09564], "w41": [53.53788, 10.09831], "w42": [53.53734, 10.1017], "w43": [53.53642, 10.10515], "w44": [53.53529, 10.10849], "w45": [53.53449, 10.1105], "w46": [53.53364, 10.11138], "w47": [53.53264, 10.11169], "w48": [53.53152, 10.11172], "w49": [53.53042, 10.11275], "w50": [53.53001, 10.11335], "w51": [53.52864, 10.11393], "w52": [53.52747, 10.11339], "w53": [53.52669, 10.11193], "w54": [53.5257, 10.11141], "w55": [53.52458, 10.11196], "w56": [53.52376, 10.11445], "w57": [53.52324, 10.11695], "w58": [53.52208, 10.11873], "w59": [53.52079, 10.12125], "w60": [53.53252, 10.07112], "w61": [53.53545, 10.07064], "w62": [53.53766, 10.06262], "w63": [53.53646, 10.06678], "w64": [53.53851, 10.05966], "w65": [53.53977, 10.05498], "w66": [53.53834, 10.05318], "w67": [53.53929, 10.04953], "w68": [53.54061, 10.04489], "w69": [53.54219, 10.04], "w70": [53.54242, 10.03665], "w71": [53.54244, 10.03344], "w72": [53.54191, 10.03135], "w73": [53.5408, 10.02923], "w74": [53.54143, 10.0273], "w75": [53.54087, 10.02611], "w76": [53.54022, 10.0279], "w77": [53.54046, 10.02499], "w78": [53.53991, 10.02398], "w79": [53.53837, 10.02542], "w80": [53.53595, 10.02691], "w81": [53.5337, 10.029], "w82": [53.53953, 10.0227], "w83": [53.54005, 10.0197], "w84": [53.54061, 10.01726], "w85": [53.54156, 10.01272], "w86": [53.54285, 10.01043], "w87": [53.5436, 10.00973], "w88": [53.5451, 10.01537], "w89": [53.54561, 10.01706], "w90": [53.54796, 10.01518], "w91": [53.54656, 10.02087], "w92": [53.54835, 10.02721], "w93": [53.54889, 10.02924], "w94": [53.55001, 10.02837], "w95": [53.54648, 10.03114], "w96": [53.54497, 10.02564], "w97": [53.54418, 10.0329], "w98": [53.54962, 10.03185], "w99": [53.55088, 10.03665], "w100": [53.55162, 10.04], "w101": [53.55181, 10.04365], "w102": [53.55152, 10.04704], "w103": [53.55111, 10.05063], "w104": [53.55065, 10.05432], "w105": [53.55023, 10.05761], "w106": [53.55004, 10.0599], "w107": [53.54965, 10.06267], "w108": [53.54754, 10.06034], "w109": [53.54793, 10.05679], "w110": [53.54824, 10.0535], "w111": [53.54867, 10.04974], "w112": [53.54898, 10.04656], "w113": [53.54912, 10.0441], "w114": [53.54893, 10.04138], "w115": [53.54843, 10.03852], "w116": [53.54744, 10.0345], "w117": [53.54297, 10.0411], "w118": [53.54435, 10.04288], "w119": [53.54425, 10.0471], "w120": [53.54335, 10.05127], "w121": [53.54421, 10.05337], "w122": [53.54497, 10.05589], "w123": [53.54575, 10.05857], "w124": [53.54602, 10.0599], "w125": [53.54265, 10.05286], "w126": [53.54174, 10.05614], "w127": [53.54093, 10.05898], "w128": [53.53999, 10.06196], "w129": [53.53914, 10.06552], "w130": [53.53878, 10.06707], "w131": [53.5402, 10.06666], "w132": [53.54207, 10.0662], "w133": [53.5435, 10.06579], "w134": [53.54477, 10.06479], "w135": [53.54552, 10.06317], "w136": [53.53757, 10.07032], "w137": [53.54523, 10.00601], "w138": [53.54373, 9.99987], "w139": [53.54347, 9.99901], "w140": [53.54154, 10.00046], "w141": [53.5395, 10.00194], "w142": [53.53889, 10.0028], "w143": [53.53919, 10.00469], "w144": [53.53927, 10.00898], "w145": [53.53882, 10.01248], "w146": [53.53859, 10.01544], "w147": [53.53813, 10.01731], "w148": [53.53743, 10.01803], "w149": [53.537, 10.01981], "w150": [53.54408, 9.99563], "w151": [53.54454, 9.9952], "w152": [53.54513, 9.99452], "w153": [53.54551, 9.99555], "w154": [53.54593, 9.99672], "w155": [53.54615, 9.99761], "w156": [53.54637, 9.99841], "w157": [53.5455, 9.99873], "w158": [53.54535, 9.99798], "w159": [53.54499, 9.99651], "w160": [53.54439, 9.99693], "w161": [53.54478, 9.99815], "w162": [53.54522, 9.99948], "w163": [53.54577, 10.00034], "w164": [53.54553, 10.00066], "w165": [53.54588, 10.00144], "w166": [53.54609, 10.00261], "w167": [53.54658, 10.00307], "w168": [53.54653, 9.99967], "w169": [53.54678, 10.00103], "w170": [53.54684, 10.0022], "w171": [53.5462, 10.00443], "w172": [53.54562, 10.00611], "w173": [53.54453, 9.99315], "w174": [53.54433, 9.99149], "w175": [53.54435, 9.98804], "w176": [53.54432, 9.98663], "w177": [53.54412, 9.98467], "w178": [53.54392, 9.98352], "w179": [53.54316, 9.9816], "w180": [53.54454, 9.98741], "w181": [53.54514, 9.98752], "w182": [53.54606, 9.98811], "w183": [53.54651, 9.98883], "w184": [53.54655, 9.99012], "w185": [53.54641, 9.99148], "w186": [53.54649, 9.99266], "w187": [53.54693, 9.99288], "w188": [53.54762, 9.99305], "w189": [53.548, 9.9924], "w190": [53.54855, 9.99152], "w191": [53.54479, 9.98367], "w192": [53.54532, 9.98345], "w193": [53.54627, 9.9836], "w194": [53.54725, 9.98444], "w195": [53.54826, 9.9852], "w196": [53.54916, 9.98636], "w197": [53.54956, 9.98703], "w198": [53.54897, 9.98784], "w199": [53.54883, 9.98869], "w200": [53.54897, 9.98971], "w201": [53.54985, 9.98782], "w202": [53.55039, 9.98919], "w203": [53.551, 9.99047], "w204": [53.55137, 9.99152], "w205": [53.55174, 9.99251], "w206": [53.55246, 9.99465], "w207": [53.55389, 9.99518], "w208": [53.55594, 9.99626], "w209": [53.55881, 9.99949], "w210": [53.5617, 10.0037], "w211": [53.56578, 10.0064], "w212": [53.56541, 10.01571], "w213": [53.56568, 10.01801], "w214": [53.56576, 10.02271], "w215": [53.56965, 10.00511], "w216": [53.57592, 10.00412], "w217": [53.57961, 9.99953], "w218": [53.54473, 9.9811], "w219": [53.54559, 9.98174], "w220": [53.54681, 9.98254], "w221": [53.54804, 9.98354], "w222": [53.54891, 9.98424], "w223": [53.54964, 9.98475], "w224": [53.55039, 9.98524], "w225": [53.5506, 9.98554], "w226": [53.55088, 9.98698], "w227": [53.55138, 9.98805], "w228": [53.55186, 9.98945], "w229": [53.55233, 9.99066], "w230": [53.54263, 9.98181], "w231": [53.54277, 9.98266], "w232": [53.54299, 9.98342], "w233": [53.54314, 9.98381], "w234": [53.54323, 9.98464], "w235": [53.5433, 9.9859], "w236": [53.5434, 9.98761], "w237": [53.54355, 9.98919], "w238": [53.54358, 9.99053], "w239": [53.54376, 9.99268], "w240": [53.54391, 9.9944], "w241": [53.54174, 9.98203], "w242": [53.54188, 9.98388], "w243": [53.54203, 9.98595], "w244": [53.54209, 9.98826], "w245": [53.54216, 9.99049], "w246": [53.54229, 9.99169], "w247": [53.54049, 9.98595], "w248": [53.54042, 9.98753], "w249": [53.53997, 9.98749], "w250": [53.54048, 9.98922], "w251": [53.54048, 9.99112], "w252": [53.54046, 9.99238], "w253": [53.54923, 10.06649], "w254": [53.53493, 10.07403], "w255": [53.52753, 10.07631], "w256": [53.52957, 10.08034], "w257": [53.52331, 10.07569], "w258": [53.53394, 10.03043], "w259": [53.53312, 10.03308], "w260": [53.54322, 10.03366], "w261": [53.54438, 10.00245], "w262": [53.54489, 10.00517], "w263": [53.51347, 10.05348], "w264": [53.51461, 10.04942], "w265": [53.5158, 10.04562], "w266": [53.51708, 10.04183], "w267": [53.51825, 10.0379], "w268": [53.51986, 10.03314], "w269": [53.52144, 10.02818], "w270": [53.52144, 10.02649], "w271": [53.5224, 10.02659], "w272": [53.52269, 10.0273], "w273": [53.52459, 10.02921], "w274": [53.52255, 10.0359], "w275": [53.52054, 10.04191], "w276": [53.51984, 10.04436], "w277": [53.51861, 10.04792], "w278": [53.51732, 10.0509], "w279": [53.51579, 10.05266], "w280": [53.52183, 10.00812], "w281": [53.52198, 10.01097], "w282": [53.52208, 10.01559], "w283": [53.52196, 10.0179], "w284": [53.52153, 10.01951], "w285": [53.52141, 10.02321], "w286": [53.52176, 10.0053], "w287": [53.52246, 10.00153], "w288": [53.5237, 9.99315], "w289": [53.52457, 9.98702], "w290": [53.52525, 9.98284], "w291": [53.5255, 9.98035], "w292": [53.52343, 9.98336], "w293": [53.52168, 9.98709], "w294": [53.52111, 9.99017], "w295": [53.5209, 9.99411], "w296": [53.52145, 10.00176], "w297": [53.52315, 9.98132], "w298": [53.52532, 9.97804], "w299": [53.52639, 9.97691], "w300": [53.51304, 9.97155], "w301": [53.51528, 9.9726], "w302": [53.51799, 9.97411], "w303": [53.52105, 9.97561], "w304": [53.51977, 9.97878], "w305": [53.52544, 9.97625], "w306": [53.51387, 9.96602], "w307": [53.51547, 9.95874], "w308": [53.51688, 9.95282], "w309": [53.518, 9.94634], "w310": [53.51907, 9.93891], "w311": [53.50271, 9.94947], "w312": [53.50629, 9.95263], "w313": [53.5008, 9.95595], "w314": [53.50401, 9.96447], "w315": [53.51085, 9.95001], "w316": [53.51654, 9.94273], "w317": [53.52326, 9.93902], "w318": [53.52179, 9.9469], "w319": [53.52074, 9.95168], "w320": [53.5199, 9.95602], "w321": [53.52716, 9.95597], "w322": [53.52532, 9.96286], "w323": [53.52565, 9.97035], "w324": [53.52532, 9.97153], "w325": [53.52016, 9.96908], "w326": [53.51799, 9.96647], "w327": [53.53357, 9.9534], "w328": [53.53105, 9.96134], "w329": [53.52831, 9.96557], "w330": [53.53352, 9.9534], "w331": [53.53697, 9.95104], "w332": [53.53573, 9.95754], "w333": [53.53312, 9.96426], "w334": [53.54171, 9.94597], "w335": [53.54209, 9.96838], "w336": [53.54054, 9.96714], "w337": [53.53917, 9.96601], "w338": [53.53861, 9.9658], "w339": [53.53825, 9.96663], "w340": [53.5372, 9.97023], "w341": [53.53846, 9.97096], "w342": [53.5363, 9.97069], "w343": [53.53303, 9.97105], "w344": [53.53071, 9.9714], "w345": [53.53276, 9.96714], "w346": [53.53334, 9.9758], "w347": [53.53137, 9.97615], "w348": [53.5288, 9.97658], "w349": [53.53264, 9.97623], "w350": [53.53252, 9.97932], "w351": [53.53232, 9.98434], "w352": [53.53487, 9.97567], "w353": [53.53653, 9.9768], "w354": [53.53876, 9.97869], "w355": [53.53363, 9.98448], "w356": [53.53573, 9.98513], "w357": [53.53723, 9.98627], "w358": [53.5259, 9.97181], "w359": [53.51078, 9.97016], "w360": [53.50874, 9.96949], "w361": [53.50672, 9.96866], "w362": [53.5038, 9.96848], "w363": [53.50347, 9.97102], "w364": [53.50233, 9.97376], "w365": [53.50122, 9.97627], "w366": [53.49886, 9.97747], "w367": [53.49608, 9.97885], "w368": [53.49301, 9.98031], "w369": [53.49101, 9.98183], "w370": [53.48696, 9.98247], "w371": [53.48323, 9.98284], "w372": [53.47823, 9.98428], "w373": [53.47659, 9.98486], "w374": [53.53981, 9.95024], "w375": [53.53939, 9.95591], "w376": [53.53735, 9.97382], "w377": [53.53984, 9.97591], "w378": [53.53599, 9.97377], "w379": [53.53496, 9.97501], "w380": [53.53439, 9.99153], "w381": [53.53297, 9.99395], "w382": [53.53124, 9.99775], "w383": [53.52976, 9.99968], "w384": [53.52822, 10.00247], "w385": [53.52647, 10.00588], "w386": [53.52458, 10.00867], "w387": [53.53168, 9.98877], "w388": [53.53477, 9.98927], "w389": [53.53637, 9.9905], "w390": [53.53554, 9.99563], "w391": [53.53412, 9.99852], "w392": [53.53554, 10.0025], "w393": [53.53423, 10.00561], "w394": [53.53278, 10.00902], "w395": [53.53139, 10.01224], "w396": [53.53031, 10.01484], "w397": [53.52922, 10.01526], "w398": [53.52715, 10.01403], "w399": [53.52522, 10.01235], "w400": [53.52389, 10.01113], "w401": [53.52505, 10.02457], "w402": [53.52824, 10.02567], "w403": [53.53276, 10.02295], "w404": [53.53338, 10.02015], "w405": [53.53419, 10.01646], "w406": [53.5355, 10.00916], "w407": [53.53614, 10.00382], "w408": [53.52457, 10.02925], "w409": [53.52646, 10.03062], "w410": [53.52856, 10.03279], "w411": [53.52812, 10.03442], "w412": [53.52611, 10.0332], "w413": [53.5247, 10.03746], "w414": [53.52972, 10.0303], "w415": [53.51111, 10.0679], "w416": [53.52636, 10.04223], "w417": [53.5247, 10.04644], "w418": [53.52276, 10.05017], "w419": [53.52102, 10.05296], "w420": [53.51839, 10.05605], "w421": [53.51531, 10.05828], "w422": [53.51263, 10.0594], "w423": [53.5089, 10.0591], "w424": [53.50482, 10.05689], "w425": [53.50321, 10.05584], "w426": [53.49936, 10.05296], "w427": [53.49545, 10.05159], "w428": [53.49144, 10.05116], "w429": [53.492, 10.04906], "w430": [53.49384, 10.04612], "w431": [53.4967, 10.04586], "w432": [53.49929, 10.04685], "w433": [53.52798, 10.04072], "w434": [53.50595, 10.05983], "w435": [53.5038, 10.06112], "w436": [53.5016, 10.06388], "w437": [53.50008, 10.06778], "w438": [53.49957, 10.07128], "w439": [53.49936, 10.0755], "w440": [53.499, 10.07922], "w441": [53.4984, 10.08348], "w442": [53.49721, 10.08699], "w443": [53.49553, 10.0897], "w444": [53.49477, 10.09023], "w445": [53.49415, 10.08725], "w446": [53.49259, 10.08835], "w447": [53.49269, 10.09116], "w448": [53.49004, 10.09099], "w449": [53.48803, 10.09136], "w450": [53.48816, 10.09298], "w451": [53.48911, 10.09308], "w452": [53.48708, 10.09313], "w453": [53.48619, 10.09211], "w454": [53.48511, 10.09394], "w455": [53.48416, 10.09552], "w456": [53.48358, 10.09943], "w457": [53.48307, 10.10287], "w458": [53.48282, 10.10414], "w459": [53.48227, 10.10765], "w460": [53.48162, 10.11137], "w461": [53.48108, 10.11477], "w462": [53.48085, 10.11731], "w463": [53.4821, 10.12476], "w464": [53.48081, 10.13242], "w465": [53.53978, 9.93095], "w466": [53.5382, 9.93417], "w467": [53.53601, 9.93701], "w468": [53.53332, 9.93913], "w469": [53.53139, 9.93997], "w470": [53.52803, 9.93988], "w471": [53.52472, 9.93928], "w472": [53.51318, 9.931], "w473": [53.51732, 9.93658], "w474": [53.51757, 9.93883], "w475": [53.51519, 9.93906], "w476": [53.51221, 9.93932], "w477": [53.50844, 9.93937], "w478": [53.50415, 9.94067], "w479": [53.50063, 9.9428], "w480": [53.49883, 9.94587], "w481": [53.49645, 9.94994], "w482": [53.49401, 9.95226], "w483": [53.49305, 9.9593], "w484": [53.48796, 9.95134], "w485": [53.48605, 9.95584], "w486": [53.48635, 9.95803], "w487": [53.48868, 9.95617], "w488": [53.49207, 9.95351], "w489": [53.47492, 9.95516], "w490": [53.47821, 9.95756], "w491": [53.4821, 9.96035], "w492": [53.4837, 9.96078], "w493": [53.47354, 9.96288], "w494": [53.47637, 9.96417], "w495": [53.47954, 9.96567], "w496": [53.48095, 9.96687], "w497": [53.47244, 9.96898], "w498": [53.47466, 9.96992], "w499": [53.47729, 9.97142], "w500": [53.47898, 9.97198], "w501": [53.47147, 9.97451], "w502": [53.47377, 9.97563], "w503": [53.47571, 9.97649], "w504": [53.47704, 9.97679], "w505": [53.46599, 9.97823], "w506": [53.4672, 9.97945], "w507": [53.46846, 9.98044], "w508": [53.4694, 9.98112], "w509": [53.47028, 9.9816], "w510": [53.47148, 9.98216], "w511": [53.4682, 9.9816], "w512": [53.46772, 9.98322], "w513": [53.46672, 9.98253], "w514": [53.46539, 9.98152], "w515": [53.46493, 9.98111], "w516": [53.46693, 9.98621], "w517": [53.46572, 9.98589], "w518": [53.46464, 9.98545], "w519": [53.46382, 9.98522], "w520": [53.46676, 9.98785], "w521": [53.46659, 9.99002], "w522": [53.46514, 9.98967], "w523": [53.4638, 9.98911], "w524": [53.46206, 9.98849], "w525": [53.46757, 9.99027], "w526": [53.4689, 9.99026], "w527": [53.46996, 9.98878], "w528": [53.46951, 9.98935], "w529": [53.46886, 9.98809], "w530": [53.46846, 9.98736], "w531": [53.47069, 9.98832], "w532": [53.47139, 9.98755], "w533": [53.47215, 9.98722], "w534": [53.4718, 9.98557], "w535": [53.4713, 9.98414], "w536": [53.47107, 9.98345], "w537": [53.46994, 9.98334], "w538": [53.46932, 9.9832], "w539": [53.46884, 9.97888], "w540": [53.4699, 9.99054], "w541": [53.46977, 9.99243], "w542": [53.46975, 9.99352], "w543": [53.46637, 9.99394], "w544": [53.47154, 9.99034], "w545": [53.47491, 9.99011], "w546": [53.4733, 9.98576], "w547": [53.47544, 9.98498], "w548": [53.5207, 9.92779], "w549": [53.5237, 9.93054], "w550": [53.52348, 9.93256], "w551": [53.5234, 9.93705], "w552": [53.47202, 9.99223], "w553": [53.47322, 9.99282], "w554": [53.47304, 9.99419], "w555": [53.472, 9.99369], "w556": [53.47434, 9.99395], "w557": [53.47258, 9.99602], "w558": [53.47125, 9.99593], "w559": [53.47079, 9.99671], "w560": [53.47044, 9.99857], "w561": [53.47031, 9.99972], "w562": [53.46982, 10.00214], "w563": [53.46927, 10.00507], "w564": [53.47104, 10.00052], "w565": [53.4723, 10.0009], "w566": [53.47197, 10.00502], "w567": [53.47074, 10.00513], "w568": [53.46969, 10.00597], "w569": [53.47044, 10.0091], "w570": [53.47245, 10.0083], "w571": [53.47303, 10.01285], "w572": [53.47425, 10.01235], "w573": [53.47483, 10.01325], "w574": [53.47512, 10.01472], "w575": [53.47366, 10.01748], "w576": [53.47366, 10.01619], "w577": [53.47476, 10.01588], "w578": [53.47563, 10.01592], "w579": [53.47669, 10.0174], "w580": [53.47763, 10.01842], "w581": [53.47814, 10.01962], "w582": [53.4781, 10.02112], "w583": [53.47243, 10.01813], "w584": [53.47187, 10.01654], "w585": [53.47221, 10.01466], "w586": [53.47323, 10.01433], "w587": [53.47809, 10.01895], "w588": [53.47431, 10.02133], "w589": [53.47431, 10.02519], "w590": [53.47564, 10.0255], "w591": [53.47659, 10.0257], "w592": [53.4772, 10.02664], "w593": [53.47692, 10.02877], "w594": [53.47448, 10.02824], "w595": [53.47371, 10.033], "w596": [53.47322, 10.03487], "w597": [53.47416, 10.03538], "w598": [53.47463, 10.0355], "w599": [53.47389, 10.03636], "w600": [53.47438, 10.03742], "w601": [53.47355, 10.04096], "w602": [53.47321, 10.0431], "w603": [53.47279, 10.0447], "w604": [53.47199, 10.04656], "w605": [53.47272, 10.03621], "w606": [53.47178, 10.03903], "w607": [53.47041, 10.03798], "w608": [53.471, 10.04092], "w609": [53.47053, 10.04186], "w610": [53.46866, 10.04493], "w611": [53.46741, 10.04731], "w612": [53.46535, 10.04989], "w613": [53.46399, 10.05177], "w614": [53.46255, 10.05407], "w615": [53.46077, 10.05734], "w616": [53.45881, 10.06134], "w617": [53.45656, 10.06606], "w618": [53.45486, 10.07075], "w619": [53.45411, 10.07639], "w620": [53.45251, 10.08152], "w621": [53.45099, 10.08551], "w622": [53.45417, 10.08159], "w623": [53.45654, 10.07554], "w624": [53.45776, 10.06972], "w625": [53.45988, 10.06663], "w626": [53.46314, 10.06376], "w627": [53.46722, 10.06245], "w628": [53.47026, 10.06178], "w629": [53.47563, 10.06236], "w630": [53.47809, 10.06116], "w631": [53.48079, 10.05826], "w632": [53.4836, 10.05438], "w633": [53.48568, 10.05159], "w634": [53.48986, 10.05101], "w635": [53.52584, 9.92688], "w636": [53.53003, 9.91662], "w637": [53.53332, 9.90774], "w638": [53.53602, 9.90454], "w639": [53.53586, 9.89463], "w640": [53.53618, 9.88757], "w641": [53.53957, 9.90063], "w642": [53.5248, 9.9274], "w643": [53.52385, 9.92974], "w644": [53.5209, 9.89589], "w645": [53.52189, 9.89207], "w646": [53.52544, 9.89177], "w647": [53.53064, 9.89164], "w648": [53.53472, 9.88302], "w649": [53.53824, 9.87761], "w650": [53.54064, 9.87486], "w651": [53.52162, 9.89411], "w652": [53.51889, 9.8889], "w653": [53.51902, 9.88597], "w654": [53.51903, 9.88395], "w655": [53.5189, 9.88086], "w656": [53.51905, 9.8763], "w657": [53.52671, 9.8271], "w658": [53.52271, 9.82877], "w659": [53.51962, 9.82985], "w660": [53.51702, 9.83611], "w661": [53.51601, 9.84457], "w662": [53.51649, 9.85508], "w663": [53.51804, 9.86042], "w664": [53.51885, 9.86293], "w665": [53.51973, 9.87062], "w666": [53.56264, 9.73303], "w667": [53.56106, 9.75122], "w668": [53.55938, 9.77517], "w669": [53.55708, 9.78805], "w670": [53.55535, 9.79774], "w671": [53.55278, 9.81337], "w672": [53.55025, 9.82697], "w673": [53.54796, 9.83959], "w674": [53.54571, 9.85281], "w675": [53.54388, 9.86268], "w676": [53.54197, 9.87401], "w677": [53.54348, 9.86568], "w678": [53.54208, 9.88804], "w679": [53.54177, 9.90021], "w680": [53.54161, 9.91372], "w681": [53.54162, 9.9293], "w682": [53.54157, 9.93979], "w683": [53.54311, 9.95248], "w684": [53.54409, 9.95801], "w685": [53.54448, 9.96444], "w686": [53.54432, 9.9685], "w687": [53.54407, 9.96985], "w688": [53.54332, 9.97258], "w689": [53.54205, 9.97658], "w690": [53.54105, 9.98015], "w691": [53.54177, 9.98118], "w692": [53.53982, 9.98379], "w693": [53.53873, 9.98707], "w694": [53.53615, 9.871], "w695": [53.53788, 9.86896], "w696": [53.5398, 9.86692], "w697": [53.54231, 9.86562], "w698": [53.53736, 9.85484], "w699": [53.53829, 9.85433], "w700": [53.53922, 9.8525], "w701": [53.54023, 9.85182], "w702": [53.54091, 9.85302], "w703": [53.54074, 9.85459], "w704": [53.54125, 9.85598], "w705": [53.54228, 9.85581], "w706": [53.54508, 9.85645], "w707": [53.54748, 9.86548], "w708": [53.54752, 9.86663], "w709": [53.54749, 9.86765], "w710": [53.54567, 9.86732], "w711": [53.54399, 9.86606], "w712": [53.47939, 10.13557], "w713": [53.47658, 10.13742], "w714": [53.47392, 10.13733], "w715": [53.47216, 10.14163], "w716": [53.47014, 10.14596], "w717": [53.47024, 10.1533], "w718": [53.47129, 10.16064], "w719": [53.47193, 10.166], "w720": [53.47175, 10.16943], "w721": [53.46938, 10.17145], "w722": [53.46793, 10.17293], "w723": [53.46634, 10.17315], "w724": [53.46493, 10.17375], "w725": [53.46399, 10.17639], "w726": [53.46359, 10.18021], "w727": [53.46447, 10.18267], "w728": [53.46636, 10.18544], "w729": [53.46713, 10.18723], "w730": [53.46653, 10.19529], "w731": [53.4696, 10.19101], "w732": [53.47132, 10.19419], "w733": [53.47284, 10.19885], "w734": [53.46626, 10.19702], "w735": [53.4656, 10.19928], "w736": [53.46471, 10.20104], "w737": [53.46368, 10.2015], "w738": [53.46719, 10.19529], "w739": [53.46772, 10.19589], "w740": [53.46872, 10.19674], "w741": [53.47026, 10.19749], "w742": [53.47215, 10.19902], "w743": [53.46996, 10.17105], "w744": [53.47043, 10.17189], "w745": [53.44824, 10.08974], "w746": [53.44515, 10.093], "w747": [53.44635, 10.09674], "w748": [53.44444, 10.0994], "w749": [53.44116, 10.09472], "w750": [53.43817, 10.09704], "w751": [53.4347, 10.09918], "w752": [53.4316, 10.10141], "w753": [53.4281, 10.1045], "w754": [53.42605, 10.10789], "w755": [53.42503, 10.11227], "w756": [53.42449, 10.11935], "w757": [53.42444, 10.1263], "w758": [53.42416, 10.13193], "w759": [53.42299, 10.13729], "w760": [53.42099, 10.14124], "w761": [53.4171, 10.14562], "w762": [53.4124, 10.14639], "w763": [53.40805, 10.14965], "w764": [53.40314, 10.15617], "w765": [53.39955, 10.16295], "w766": [53.39679, 10.16922], "w767": [53.39597, 10.17385], "w768": [53.3973, 10.18227], "w769": [53.39899, 10.19274]
}; 
    
    // !!! HIER DEINE connections VARIABLE EINF√úGEN !!!
    const connections = [
 ["w1","w7"],["w7","w8"],["w8","w9"],["w9","w23"],["w23","w24",{"name":"Tiefstackschleuse","type":"lock"}],["w24","w25"],["w25","w26"],["w26","w60"],["w60","w27"],["w27","w61"],["w61","w63"],["w63","w62"],["w62","w64"],["w64","w65"],["w65","w66"],["w66","w67"],["w67","w68"],["w68","w69"],["w69","w117"],["w118","w117"],["w118","w119"],["w119","w120"],["w120","w121"],["w121","w122"],["w122","w123"],["w123","w124"],["w124","w108"],["w108","w109"],["w109","w110"],["w110","w111"],["w111","w112"],["w112","w113"],["w113","w114"],["w114","w115"],["w115","w116"],["w116","w95"],["w95","w96"],["w95","w93"],["w93","w94"],["w93","w92"],["w92","w91"],["w91","w89"],["w89","w90"],["w89","w88"],["w88","w87"],["w93","w98"],["w98","w99"],["w99","w100"],["w100","w101"],["w101","w102"],["w102","w103"],["w103","w104"],["w104","w105"],["w105","w106"],["w106","w107"],["w107","w108"],["w107","w253"],["w124","w135"],["w135","w134"],["w134","w133"],["w133","w132"],["w132","w131"],["w131","w130"],["w130","w129"],["w129","w128"],["w128","w127"],["w127","w126"],["w126","w125"],["w125","w120"],["w130","w136"],["w136","w32"],["w32","w27"],["w27","w254"],["w254","w28"],["w28","w29"],["w29","w30"],["w30","w31"],["w32","w33"],["w33","w34"],["w34","w35"],["w35","w36"],["w36","w37"],["w37","w38"],["w38","w39"],["w39","w40"],["w40","w41"],["w41","w42"],["w42","w43"],["w43","w44"],["w44","w45"],["w45","w46"],["w46","w47"],["w47","w48"],["w48","w49"],["w49","w50"],["w50","w51"],["w51","w52"],["w52","w53"],["w53","w54"],["w54","w55"],["w55","w56"],["w56","w57"],["w57","w58"],["w58","w59"],["w14","w15"],["w15","w255"],["w255","w256"],["w256","w16"],["w16","w19"],["w19","w20"],["w16","w21"],["w21","w22"],["w15","w257"],["w257","w17"],["w17","w18"],["w9","w10"],["w10","w14"],["w1","w2"],["w2","w81"],["w81","w258"],["w258","w259"],["w81","w80"],["w80","w79"],["w79","w82"],["w82","w78"],["w78","w79"],["w78","w77"],["w77","w75"],["w75","w76"],["w75","w74"],["w74","w73"],["w73","w72"],["w72","w71"],["w71","w70"],["w70","w69"],["w95","w97"],["w97","w260"],["w260","w71"],["w82","w83"],["w83","w84"],["w84","w85"],["w85","w86"],["w86","w87"],["w87","w172"],["w172","w171"],["w171","w167"],["w167","w170"],["w170","w169"],["w169","w168"],["w168","w156"],["w156","w155"],["w155","w154"],["w154","w153"],["w153","w152"],["w152","w151"],["w151","w159"],["w159","w158"],["w158","w157"],["w157","w156"],["w157","w163",{"type":"barrier"}],["w163","w165"],["w165","w166"],["w166","w167"],["w165","w164"],["w164","w162"],["w162","w161"],["w161","w138",{"type":"barrier"}],["w138","w261"],["w261","w262"],["w262","w137"],["w137","w172"],["w138","w139"],["w139","w140"],["w140","w141"],["w141","w142"],["w142","w143"],["w143","w144"],["w144","w145"],["w145","w146"],["w146","w147"],["w147","w148"],["w148","w149"],["w142","w4"],["w161","w160"],["w160","w150"],["w150","w151"],["w150","w240"],["w240","w239"],["w239","w238"],["w238","w237"],["w237","w236"],["w236","w235"],["w235","w234"],["w234","w233"],["w233","w232"],["w232","w231"],["w231","w230"],["w152","w173"],["w173","w174"],["w174","w175"],["w175","w180"],["w180","w176"],["w176","w177"],["w177","w178"],["w178","w179"],["w176","w175"],["w180","w181"],["w181","w182"],["w182","w183"],["w183","w184"],["w184","w185"],["w185","w186"],["w186","w187"],["w187","w188"],["w188","w189"],["w189","w190"],["w200","w199"],["w199","w198"],["w198","w197"],["w197","w201"],["w201","w202"],["w202","w203"],["w203","w204"],["w204","w205"],["w205","w206"],["w206","w207"],["w207","w208"],["w208","w209"],["w209","w210"],["w210","w211"],["w211","w212"],["w212","w213"],["w213","w214"],["w211","w215"],["w215","w216"],["w216","w217"],["w229","w228"],["w228","w227"],["w227","w226"],["w226","w225"],["w225","w224"],["w224","w223"],["w223","w222"],["w222","w221"],["w221","w220"],["w220","w219"],["w219","w218"],["w197","w196"],["w196","w195"],["w195","w194"],["w194","w193"],["w193","w192"],["w192","w191"],["w191","w178"],["w191","w177"],["w246","w245"],["w245","w244"],["w244","w243"],["w243","w242"],["w242","w241"],["w252","w251"],["w251","w250"],["w250","w248"],["w248","w249"],["w247","w248"],["w271","w270"],["w270","w269"],["w269","w268"],["w268","w267"],["w267","w266"],["w266","w265"],["w265","w264"],["w264","w263"],["w271","w272"],["w272","w273"],["w273","w274",{"type":"barrier"}],["w274","w275"],["w275","w276"],["w276","w266",{"type":"barrier"}],["w276","w277"],["w277","w278"],["w278","w279"],["w279","w263",{"type":"barrier"}],["w280","w281"],["w281","w282"],["w282","w283"],["w283","w284"],["w284","w285"],["w285","w270"],["w280","w286"],["w286","w296"],["w296","w295"],["w295","w294"],["w294","w293"],["w293","w292"],["w292","w291"],["w291","w290"],["w290","w289"],["w289","w288"],["w288","w287"],["w287","w286"],["w299","w298"],["w298","w297"],["w291","w299"],["w299","w305"],["w305","w303"],["w303","w304"],["w303","w302"],["w302","w301"],["w301","w300"],["w310","w309"],["w309","w308"],["w308","w307"],["w307","w306"],["w316","w315"],["w315","w312"],["w312","w311"],["w312","w313"],["w312","w314"],["w326","w325"],["w325","w324"],["w324","w323"],["w323","w322"],["w322","w321"],["w321","w320"],["w320","w319"],["w319","w318"],["w318","w317"],["w327","w328"],["w328","w329"],["w327","w321"],["w330","w331"],["w331","w332"],["w332","w333"],["w334","w331"],["w344","w343"],["w343","w342"],["w342","w340"],["w340","w341"],["w340","w339"],["w339","w338"],["w338","w337"],["w337","w336"],["w336","w335"],["w333","w345"],["w345","w343"],["w299","w348"],["w348","w347"],["w347","w346"],["w346","w343"],["w347","w349"],["w349","w346"],["w349","w350"],["w350","w351"],["w354","w353"],["w353","w352"],["w352","w346"],["w351","w355"],["w355","w356"],["w356","w357"],["w323","w358"],["w358","w324"],["w358","w299"],["w314","w362"],["w362","w361"],["w361","w360"],["w360","w359"],["w359","w300"],["w373","w372"],["w372","w371"],["w371","w370"],["w370","w369"],["w369","w368"],["w368","w367"],["w367","w366"],["w366","w365"],["w365","w364"],["w364","w363"],["w363","w362"],["w334","w374"],["w374","w331"],["w374","w375"],["w376","w377"],["w378","w379"],["w379","w352"],["w386","w385"],["w385","w384"],["w384","w383"],["w383","w382"],["w382","w381"],["w381","w380"],["w387","w388"],["w388","w389"],["w389","w380"],["w380","w388"],["w389","w6"],["w6","w5"],["w5","w390"],["w390","w391"],["w386","w400"],["w400","w399"],["w399","w398"],["w398","w397"],["w397","w396"],["w396","w395"],["w395","w394"],["w394","w393"],["w393","w392"],["w392","w4"],["w5","w4"],["w402","w3"],["w3","w2"],["w4","w407"],["w407","w406"],["w406","w405"],["w405","w404"],["w404","w403"],["w403","w3"],["w273","w409"],["w409","w410"],["w2","w414"],["w414","w410"],["w410","w411"],["w411","w412"],["w412","w413"],["w411","w1"],["w415","w12"],["w12","w13"],["w13","w11"],["w11","w12"],["w11","w10"],["w432","w431"],["w431","w430"],["w430","w429"],["w429","w428"],["w428","w427"],["w427","w426"],["w426","w425"],["w425","w424"],["w424","w423"],["w423","w422"],["w422","w421"],["w421","w420"],["w420","w419"],["w419","w418"],["w418","w417"],["w417","w416"],["w416","w1"],["w7","w433"],["w433","w416"],["w464","w463"],["w463","w462"],["w462","w461"],["w461","w460"],["w460","w459"],["w459","w458"],["w458","w456"],["w456","w455"],["w455","w454"],["w454","w453"],["w453","w449"],["w449","w450"],["w450","w451"],["w450","w452"],["w449","w448"],["w448","w447"],["w447","w444"],["w444","w445"],["w445","w446"],["w446","w447"],["w444","w443"],["w443","w442"],["w442","w441"],["w441","w440"],["w440","w439"],["w439","w438"],["w438","w437"],["w437","w436"],["w436","w435"],["w435","w434"],["w434","w423"],["w317","w471"],["w471","w470"],["w470","w469"],["w469","w468"],["w468","w467"],["w467","w466"],["w466","w465"],["w317","w310"],["w472","w473"],["w473","w474"],["w474","w310"],["w474","w316"],["w483","w482"],["w482","w481"],["w481","w480"],["w480","w479"],["w479","w478"],["w478","w477"],["w477","w476"],["w476","w475"],["w475","w474"],["w484","w485"],["w485","w486"],["w486","w487"],["w487","w488"],["w488","w482"],["w489","w490"],["w490","w491"],["w491","w492"],["w492","w486"],["w493","w494"],["w494","w495"],["w495","w496"],["w496","w492"],["w497","w498"],["w498","w499"],["w499","w500"],["w500","w496"],["w501","w502"],["w502","w503"],["w503","w504"],["w504","w500"],["w539","w507"],["w507","w508"],["w508","w509"],["w509","w510"],["w505","w506"],["w506","w507"],["w507","w511"],["w511","w512"],["w512","w513"],["w513","w514"],["w514","w515"],["w512","w516"],["w516","w517"],["w517","w518"],["w518","w519"],["w516","w520"],["w520","w521"],["w521","w522"],["w522","w523"],["w523","w524"],["w521","w525"],["w525","w526"],["w526","w528"],["w528","w529"],["w529","w530"],["w528","w527"],["w527","w531"],["w531","w532"],["w532","w533"],["w533","w534"],["w534","w535"],["w535","w536"],["w536","w537"],["w537","w538"],["w526","w540"],["w540","w541"],["w541","w542"],["w542","w543"],["w504","w547"],["w547","w545"],["w546","w547"],["w547","w373"],["w545","w544"],["w544","w540"],["w548","w549"],["w549","w550"],["w550","w551"],["w551","w317"],["w545","w553"],["w553","w552"],["w555","w554"],["w554","w553"],["w553","w556"],["w556","w545"],["w556","w554"],["w554","w557"],["w557","w558"],["w558","w559"],["w559","w560"],["w560","w561"],["w561","w562"],["w562","w563"],["w561","w564"],["w564","w565"],["w565","w557"],["w557","w556"],["w569","w568"],["w568","w567"],["w567","w566"],["w566","w565"],["w574","w573"],["w573","w572"],["w572","w571"],["w571","w570"],["w570","w566"],["w571","w586"],["w586","w585"],["w586","w576"],["w576","w577"],["w577","w578"],["w578","w579"],["w579","w580"],["w580","w587"],["w587","w581"],["w581","w582"],["w576","w575"],["w575","w583"],["w583","w584"],["w593","w592"],["w592","w591"],["w591","w590"],["w590","w589"],["w589","w588"],["w588","w575"],["w589","w594"],["w594","w595"],["w595","w596"],["w596","w597"],["w597","w598"],["w596","w599"],["w599","w597"],["w599","w600"],["w600","w601"],["w601","w602"],["w602","w603"],["w603","w604"],["w428","w634"],["w634","w633"],["w633","w632"],["w632","w631"],["w631","w630"],["w630","w629"],["w629","w628"],["w628","w627"],["w627","w626"],["w626","w625"],["w625","w624"],["w624","w623"],["w623","w622"],["w622","w621"],["w621","w620"],["w620","w619"],["w619","w618"],["w618","w617"],["w617","w616"],["w616","w615"],["w615","w614"],["w614","w613"],["w613","w612"],["w612","w611"],["w611","w610"],["w610","w609"],["w609","w608"],["w608","w606"],["w606","w607"],["w606","w605"],["w605","w596"],["w549","w643"],["w643","w642"],["w642","w635"],["w635","w636"],["w636","w637"],["w637","w638"],["w638","w639"],["w639","w640"],["w638","w641"],["w650","w649"],["w649","w648"],["w648","w647"],["w647","w646"],["w646","w645"],["w656","w655"],["w655","w654"],["w654","w653"],["w653","w652"],["w652","w651"],["w651","w645"],["w651","w644"],["w656","w665"],["w665","w664"],["w664","w663"],["w663","w662"],["w662","w661"],["w661","w660"],["w660","w659"],["w659","w658"],["w658","w657"],["w6","w693"],["w693","w249"],["w357","w693"],["w693","w692"],["w692","w247"],["w692","w690"],["w690","w354"],["w377","w689"],["w689","w690"],["w690","w691"],["w691","w241"],["w179","w230"],["w230","w691"],["w335","w687"],["w687","w688"],["w688","w689"],["w685","w686"],["w686","w687"],["w685","w684"],["w684","w683"],["w683","w334"],["w334","w682"],["w682","w681"],["w681","w465"],["w681","w680"],["w680","w679"],["w679","w641"],["w679","w678"],["w678","w676"],["w676","w650"],["w698","w699"],["w699","w700"],["w700","w701"],["w701","w702"],["w702","w703"],["w703","w704"],["w704","w705"],["w705","w706"],["w706","w675"],["w675","w677"],["w677","w697"],["w697","w696"],["w696","w695"],["w695","w694"],["w677","w676"],["w677","w711"],["w711","w710"],["w710","w709"],["w709","w708"],["w708","w707"],["w706","w674"],["w674","w673"],["w673","w672"],["w672","w671"],["w671","w670"],["w670","w669"],["w669","w668"],["w668","w667"],["w667","w666"],["w733","w732"],["w732","w731"],["w731","w729"],["w729","w730"],["w730","w734"],["w734","w735"],["w735","w736"],["w736","w737"],["w730","w738"],["w738","w739"],["w733","w742",{"type":"barrier"}],["w742","w741"],["w741","w740"],["w740","w739"],["w729","w728"],["w728","w727"],["w727","w726"],["w726","w725"],["w725","w724"],["w724","w723"],["w723","w722"],["w722","w721"],["w721","w743"],["w743","w744"],["w743","w720"],["w720","w719"],["w719","w718"],["w718","w717"],["w717","w716"],["w716","w715"],["w715","w714"],["w714","w713"],["w713","w712"],["w712","w464"],["w748","w747"],["w747","w746"],["w746","w745"],["w745","w621"]
];

    // !!! HIER DEINE riverGeometries VARIABLE EINF√úGEN !!!
    const riverGeometries = [
        { path: [[53.54276,9.87851], [53.54225,9.8931], [53.54174,9.90753], [53.54153,9.92539], [53.54133,9.94033], [53.54337,9.95149], [53.54429,9.96128], [53.54367,9.96969], [53.54214,9.97639], [53.5401,9.98223], [53.53796,9.9903], [53.53694,9.99734], [53.53663,10.0061], [53.53541,10.01382], [53.53337,10.02189], [53.53031,10.03203], [53.52684,10.04078], [53.52255,10.05074], [53.51837,10.05624], [53.51418,10.05899], [53.50816,10.05882]], weight: 10 },
        { path: [[53.5332, 9.8510], [53.5285, 9.8700], [53.5220, 9.8850], [53.5170, 9.9050], [53.5130, 9.9250], [53.51128, 9.94005]], weight: 8 },
        { path: [[53.54174,9.92778], [53.53786,9.93447], [53.53281,9.93885], [53.52551,9.93885], [53.51745,9.93877], [53.51128,9.94005], [53.50387,9.94023], [53.49913,9.94452], [53.49591,9.94976], [53.48728,9.95731], [53.48181,9.9647], [53.47844,9.97273], [53.47533,9.98286], [53.47415,9.99179], [53.47267,10.00346], [53.47313,10.01248], [53.47415,10.01969], [53.4742,10.02914], [53.47298,10.03562], [53.47022,10.04185], [53.46445,10.05061], [53.45709,10.06469], [53.45443,10.07757]], weight: 8 },
        { path: [[53.54166,9.91428], [53.54168,9.92243], [53.53962,9.93076], [53.53722,9.93458], [53.53355,9.93819], [53.52926,9.93914], [53.52225,9.93875]], weight: 6 },
        { path: [[53.5401,9.97957], [53.53773,9.97785], [53.5359,9.97626], [53.53459,9.97566], [53.53235,9.976], [53.52906,9.97648], [53.52611,9.97659], [53.52283,9.97605], [53.52046,9.97536], [53.51556,9.97291], [53.51008,9.97025], [53.50546,9.96878], [53.50341,9.96989], [53.50153,9.97539], [53.4977,9.97797], [53.49371,9.98037], [53.48999,9.98157], [53.48616,9.98209], [53.48212,9.98277], [53.47798,9.98432], [53.47543,9.98501]], weight: 6 },
        { path: [[53.53714,9.99777], [53.53804,10.00039], [53.53898,10.00275], [53.53929,10.00653], [53.5389,10.01159]], weight: 3 },
        { path: [[53.53651,9.99022], [53.53465,9.99138], [53.53281,9.99464], [53.53079,9.99825], [53.52886,10.00099], [53.52653,10.00451], [53.52516,10.00726]], weight: 4 },
        { path: [[53.53615,10.00181], [53.53472,10.00421], [53.53322,10.00803], [53.53095,10.01348], [53.52942,10.01515], [53.52595,10.01314]], weight: 4 }
    ];
    
    // BSH Data (Jan 2026 Sample)
    const bshData = `
VB2#DE__508P# #H#Do# 1. 1.2026# 1:26# 7.05 #
VB2#DE__508P# #N#Do# 1. 1.2026# 8:43# 3.55 #
VB2#DE__508P# #H#Do# 1. 1.2026#14:02# 7.28 #
VB2#DE__508P# #N#Do# 1. 1.2026#21:20# 3.58 #
`;

    // --- 3. LOGIC ---
    let map, routeLayer, myPosLayer, currentLayer, boatMarker;
    let mapBaseLayer; // Referenz f√ºr den Kartenhintergrund
    let graph = {};
    let navMode = false;
    let myPos = null;
    let boatHeading = 0;
    let sarRunning = false, sarStart = null, sarPt = null, sarInt = null;
    let autoCenter = true; // Button State
    let flowVisible = true;
    let trendDiff = 0;
    let currentSpeed = 0;
    let navPath = [];
    let nextWpIndex = 0;

    // INIT
    window.onload = function() {
        initMap();
        buildGraph();
        
        // Data Fetching
        updateHydro();
        setInterval(updateHydro, 60000);
        setInterval(fetchWeather, 600000);
        fetchWeather();
        parseBSH();
        
        // Main Loop
        requestAnimationFrame(mainLoop);
    };

    function initMap() {
        map = L.map('map', {zoomControl: false, attributionControl: false}).setView([53.535, 9.980], 13);
        
        // Base Layers
        mapBaseLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
        L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', { opacity: 0.9 }).addTo(map);

        routeLayer = L.layerGroup().addTo(map);
        currentLayer = L.layerGroup().addTo(map);
        myPosLayer = L.layerGroup().addTo(map);

        map.on('click', onMapClick);

        // FEATURE: Auto-Center ausschalten, wenn der User die Karte bewegt
        map.on('dragstart', function() {
            if(autoCenter) toggleAutoCenter(); // Schaltet Button aus, wenn man manuell wischt
        });
        
        // NEUE GPS LOGIK (Native Browser API statt Leaflet Helper)
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(
                (pos) => {
                    myPos = L.latLng(pos.coords.latitude, pos.coords.longitude);
                    
                    // Umrechnung m/s in Knoten
                    if(pos.coords.speed !== null) currentSpeed = pos.coords.speed * 1.94384; 
                    // Kurs √ºbernehmen (falls verf√ºgbar, sonst alten behalten)
                    if(pos.coords.heading !== null && !isNaN(pos.coords.heading)) boatHeading = pos.coords.heading;
                    
                    drawBoat();
                    
                    // Hier ist die strikte Kontrolle: Nur zentrieren, wenn Variable true ist
                    if(autoCenter) {
                        // animate: true sorgt f√ºr sanftes Gleiten statt hartem Sprung
                        map.panTo(myPos, {animate: true});
                    }
                },
                (err) => { console.error("GPS Error", err); },
                { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
            );
        } else {
            showSysMsg("Dein Browser unterst√ºtzt kein GPS.", "FEHLER");
        }
    }

    

    function buildGraph() {
        graph = {};
        if(Object.keys(waypoints).length === 0) return;
        
        for (let id in waypoints) {
            graph[id] = { id: id, lat: waypoints[id][0], lng: waypoints[id][1], edges: [] };
        }
        connections.forEach(conn => {
            const a = conn[0];
            const b = conn[1];
            if(graph[a] && graph[b]) {
                const dist = map.distance([graph[a].lat, graph[a].lng], [graph[b].lat, graph[b].lng]);
                graph[a].edges.push({ target: b, dist: dist });
                graph[b].edges.push({ target: a, dist: dist });
            }
        });
    }

    // --- DIJKSTRA ROUTING ---
    function findNearest(ll) {
        let minD = Infinity, best = null;
        for(let id in graph) {
            const d = map.distance(ll, [graph[id].lat, graph[id].lng]);
            if(d < minD) { minD = d; best = id; }
        }
        return best;
    }

    function calculateRoute(startLL, endLL) {
        if(Object.keys(graph).length === 0) return [startLL, endLL];
        
        const startId = findNearest(startLL);
        const endId = findNearest(endLL);
        if(!startId || !endId || startId === endId) return [startLL, endLL];

        let dists = {}, prev = {}, pq = [{id: startId, d:0}];
        for(let id in graph) dists[id] = Infinity;
        dists[startId] = 0;

        while(pq.length > 0) {
            pq.sort((a,b)=>a.d - b.d);
            let u = pq.shift().id;
            if(u === endId) break;

            graph[u].edges.forEach(e => {
                let alt = dists[u] + e.dist;
                if(alt < dists[e.target]) {
                    dists[e.target] = alt;
                    prev[e.target] = u;
                    pq.push({id:e.target, d:alt});
                }
            });
        }

        let path = [], u = endId;
        if(prev[u] || u === startId) {
            while(u) { path.unshift(L.latLng(graph[u].lat, graph[u].lng)); u = prev[u]; }
        }
        if(path.length > 0) {
            path.unshift(startLL);
            path.push(endLL);
            return path;
        } else {
            return [startLL, endLL];
        }
    }

    // --- INTERACTION ---
    function toggleNavMode() {
        navMode = !navMode;
        const btn = document.getElementById('btn-nav');
        if(navMode) {
            btn.classList.add('active');
            map.getContainer().style.cursor = 'crosshair';
            autoCenter = false; 
            document.getElementById('btn-center').classList.remove('active');
            document.getElementById('map').style.transform = `rotate(0deg)`;
            showSysMsg("Klicke jetzt auf die Karte, um dein ZIEL zu setzen.", "NAVIGATION START");
        } else {
            stopNavigation();
        }
    }

    function onMapClick(e) {
        if(document.getElementById('sar-modal').style.display === 'block') return;
        if(!myPos) { myPos = e.latlng; drawBoat(); }

        if(navMode) {
            const path = calculateRoute(myPos, e.latlng);
            navPath = path;
            nextWpIndex = 1;

            routeLayer.clearLayers();
            L.polyline(navPath, {color: '#ef4444', weight: 6, opacity: 0.9}).addTo(routeLayer);
            L.circleMarker(e.latlng, {color:'#ef4444', radius:8}).addTo(routeLayer);

            document.getElementById('nav-hud').style.display = 'block';
            autoCenter = true;
            document.getElementById('btn-center').classList.add('active');
            map.getContainer().style.cursor = '';
        }
    }

    function stopNavigation() {
        navMode = false;
        navPath = [];
        document.getElementById('btn-nav').classList.remove('active');
        document.getElementById('nav-hud').style.display = 'none';
        routeLayer.clearLayers();
        autoCenter = false;
        document.getElementById('btn-center').classList.remove('active');
        document.getElementById('map').style.transform = `rotate(0deg)`;
        map.getContainer().style.cursor = '';
    }

    function toggleAutoCenter() {
        autoCenter = !autoCenter;
        const btn = document.getElementById('btn-center');
        if(autoCenter) {
            btn.classList.add('active');
            if(myPos) map.setView(myPos, map.getZoom());
        } else {
            btn.classList.remove('active');
            document.getElementById('map').style.transform = `rotate(0deg)`;
        }
    }

    // --- VISUAL LOOP ---
    function mainLoop() {
        if(myPos && navMode && autoCenter) {
            const mapEl = document.getElementById('map');
            mapEl.style.transformOrigin = "center center";
            mapEl.style.transform = `rotate(-${boatHeading}deg)`;
            
            let z = 14;
            if(currentSpeed < 5) z=16;
            else if(currentSpeed < 15) z=15;
            
            if(map.getZoom() !== z) map.setZoom(z, {animate:false});
            map.panTo(myPos, {animate: false});
            updateNavState();
        }
        requestAnimationFrame(mainLoop);
    }
    
    function updateNavState() {
        if(navPath.length === 0 || nextWpIndex >= navPath.length) return;
        
        const distToWp = map.distance(myPos, navPath[nextWpIndex]);
        const distToTarget = map.distance(myPos, navPath[navPath.length-1]);
        
        document.getElementById('hud-dist').innerText = (distToTarget/1852).toFixed(2);
        document.getElementById('hud-sog').innerText = currentSpeed.toFixed(1);
        document.getElementById('hud-cog').innerText = Math.round(boatHeading).toString().padStart(3,'0');
        
        if(distToWp < 80) { 
             nextWpIndex++;
             if(nextWpIndex >= navPath.length) {
                 document.getElementById('turn-text').innerText = "ZIEL ERREICHT";
                 document.getElementById('turn-arrow').innerText = "üèÅ";
                 return;
             }
        }
        
        document.getElementById('turn-dist').innerText = Math.round(distToWp) + " m";
        
        if(navPath[nextWpIndex+1]) {
            const currentWp = navPath[nextWpIndex];
            const nextWp = navPath[nextWpIndex+1];
            
            const b1 = L.GeometryUtil.bearing(myPos, currentWp);
            const b2 = L.GeometryUtil.bearing(currentWp, nextWp);
            
            let diff = (b2 - b1 + 360) % 360;
            if(diff > 180) diff -= 360;
            
            if(diff > 25) {
                document.getElementById('turn-text').innerText = "STEUERBORD";
                document.getElementById('turn-text').style.color = "#22c55e"; 
                document.getElementById('turn-arrow').innerText = "‚ÜóÔ∏è";
            } else if(diff < -25) {
                document.getElementById('turn-text').innerText = "BACKBORD";
                document.getElementById('turn-text').style.color = "#ef4444"; 
                document.getElementById('turn-arrow').innerText = "‚ÜñÔ∏è";
            } else {
                document.getElementById('turn-text').innerText = "KURS HALTEN";
                const isDay = document.body.classList.contains('day-mode');
                document.getElementById('turn-text').style.color = isDay ? "#0f172a" : "#fff";
                document.getElementById('turn-arrow').innerText = "‚¨ÜÔ∏è";
            }
        } else {
             document.getElementById('turn-text').innerText = "ZUM ZIEL";
             document.getElementById('turn-arrow').innerText = "üèÅ";
        }
    }

    function drawBoat() {
        // Wenn noch kein Marker da ist -> Erstellen
        if(!boatMarker) {
             const icon = L.divIcon({
                className: 'boat-wrap',
                html: '<i class="fa-solid fa-location-arrow boat-icon"></i>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            // Marker erstellen und global speichern
            boatMarker = L.marker(myPos, {icon: icon, zIndexOffset: 1000}).addTo(myPosLayer);
        } else {
            // Wenn schon da -> Nur Position updaten (KEIN Flackern mehr)
            boatMarker.setLatLng(myPos);
        }
        
        // Rotation des Icons anpassen
        const iconEl = document.querySelector('.boat-icon');
        if(iconEl) iconEl.style.transform = `rotate(${boatHeading - 45}deg)`;
    }

    // --- DATA FETCH ---
    async function updateHydro() {
        try {
            const res = await fetch("https://www.pegelonline.wsv.de/webservices/rest-api/v2/stations/d488c5cc-4de9-4631-8ce1-0db0e700b546/W/measurements.json?start=P0DT0H20M");
            const data = await res.json();
            const val = data[data.length-1].value;
            document.getElementById('val-pegel').innerText = val;
            const diff = val - data[0].value;
            trendDiff = diff; 
            document.getElementById('val-trend').innerText = (diff>0?"+":"")+diff;
            
            const sm = document.getElementById('val-tide-status');
            if(diff < 0) { sm.innerText="ABLAUFEND"; sm.style.color="#22d3ee"; }
            else { sm.innerText="AUFLAUFEND"; sm.style.color="#fbbf24"; }
            
            document.getElementById('status-dot').style.color="var(--good)";
            document.getElementById('status-dot').innerText="‚óè ONLINE";
            
            const speed = 0.2 + (Math.abs(trendDiff)/100)*1.5;
            document.getElementById('val-flow').innerText = speed.toFixed(1) + " m/s";
            
            drawCurrents();
        } catch(e) {
            console.log("Offline");
            document.getElementById('status-dot').style.color="orange";
            document.getElementById('val-tide-status').innerText = "OFFLINE";
            document.getElementById('val-pegel').innerText = "520 (Sim)";
        }
        updateTiefstack();
    }
    
    function drawCurrents() {
        currentLayer.clearLayers();
        if(!flowVisible || riverGeometries.length === 0) return;
        const isEbbe = (trendDiff < 0);
        const color = isEbbe ? "#22d3ee" : "#fbbf24";
        const delay = Math.max(500, 3000 - (Math.abs(trendDiff)*20));

        riverGeometries.forEach(item => {
            const river = L.polyline.antPath(item.path, {
                delay: delay, dashArray: [10, 20], weight: item.weight,
                color: "rgba(255,255,255,0.05)", pulseColor: color,
                paused: false, reverse: isEbbe
            });
            river.addTo(currentLayer);
        });
    }

    function toggleFlow() {
        flowVisible = !flowVisible;
        document.getElementById('btn-flow').classList.toggle('active');
        drawCurrents();
    }

    async function fetchWeather() {
        try {
             const wRes = await fetch('https://api.open-meteo.com/v1/forecast?latitude=53.55&longitude=9.97&current=temperature_2m,wind_speed_10m,wind_direction_10m&daily=sunrise,sunset&timezone=Europe%2FBerlin');
             const wData = await wRes.json();
             document.getElementById('val-air').innerText = Math.round(wData.current.temperature_2m)+"¬∞";
             document.getElementById('val-wind').innerText = Math.round(wData.current.wind_speed_10m)+" km/h";
             document.getElementById('val-sunrise').innerText = wData.daily.sunrise[0].split('T')[1];
             document.getElementById('val-sunset').innerText = wData.daily.sunset[0].split('T')[1];
        } catch(e){}
        document.getElementById('val-water').innerText = "6¬∞"; 
        updateHypothermia(6);
    }
    
    function updateHypothermia(t) {
        const el = document.getElementById('hypo-warn');
        if(t<5) { el.innerText="‚ö†Ô∏è LEBENSGEFAHR <15 MIN"; el.style.color="#ef4444"; }
        else if(t<10) { el.innerText="‚ö†Ô∏è KRITISCH <1 STD"; el.style.color="#f97316"; }
        else { el.innerText="AKUT STABIL"; el.style.color="#22c55e"; }
    }

    function updateTiefstack() {
        const h = new Date().getHours();
        const el = document.getElementById('ts-status');
        if(h > 6 && h < 22) { el.innerText="OFFEN"; el.style.color="var(--good)"; }
        else { el.innerText="GESCHLOSSEN"; el.style.color="var(--alert)"; }
    }

    function parseBSH() {
        if(!bshData) return;
        const lines = bshData.split('\n');
        let parsedTides = [];
        lines.forEach(l => {
            if(!l.includes("VB2")) return;
            const p = l.split('#');
            const d = p[5].trim().split('.'); const t = p[6].trim().split(':');
            if(d.length<3) return;
            parsedTides.push({ time: new Date(parseInt(d[2]), parseInt(d[1])-1, parseInt(d[0]), parseInt(t[0]), parseInt(t[1])), type: p[3].trim() });
        });
        parsedTides.sort((a,b)=>a.time-b.time);
        const now = new Date(); 
        let next = parsedTides.find(e => e.time > now);
        if(!next && parsedTides.length>0) next = parsedTides[0]; 
        if(next) {
            const hw = parsedTides.find(e => e.time >= next.time && e.type === 'H');
            const nw = parsedTides.find(e => e.time >= next.time && e.type === 'N');
            if(hw) document.getElementById('next-hw').innerText = hw.time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            if(nw) document.getElementById('next-nw').innerText = nw.time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            const diff = Math.round((next.time - now)/60000);
            if (diff > 0) document.getElementById('tide-count').innerText = `Noch ${Math.floor(diff/60)}h ${diff%60}m bis ${next.type==='H'?'HW':'NW'}`;
        }
    }

    // Ersetzt den nativen alert()
    function showSysMsg(text, title="NAVIGATION") {
        document.getElementById('sys-msg-text').innerText = text;
        document.getElementById('sys-msg-title').innerText = title;
        document.getElementById('sys-msg-overlay').style.display = 'flex';
    }

    function closeSysMsg() {
        document.getElementById('sys-msg-overlay').style.display = 'none';
    }

    // --- UI HELPERS ---
    
    // 0 = Dark (Default), 1 = Light (Day), 2 = Night (Red)
    let currentTheme = 0; 

    function toggleFullscreen() {
        const doc = document.documentElement;
        const btn = document.getElementById('btn-full');
        
        // Pr√ºfen, ob wir schon im Vollbild sind
        const isFull = document.fullscreenElement || document.webkitFullscreenElement;

        if (!isFull) {
            // Vollbild starten (mit Fallback f√ºr Safari/iOS 'webkit')
            if (doc.requestFullscreen) {
                doc.requestFullscreen();
            } else if (doc.webkitRequestFullscreen) {
                doc.webkitRequestFullscreen();
            }
            btn.classList.add('active'); // Button leuchten lassen
        } else {
            // Vollbild beenden
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            }
            btn.classList.remove('active');
        }
    }

    function toggleNight() { 
        currentTheme = (currentTheme + 1) % 3; // Zyklus: 0 -> 1 -> 2 -> 0
        const btn = document.getElementById('btn-night');
        
        // Reset classes
        document.body.classList.remove('night-mode', 'day-mode');
        // Reset Textfarben (Default Weiss)
        document.getElementById('turn-text').style.color = "#fff";

        if (currentTheme === 0) {
            // === MODUS 0: DARK (Standard) ===
            btn.innerText = "üåô";
            btn.style.background = ""; 
            btn.style.color = "#fff";
            mapBaseLayer.setUrl('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
        
        } else if (currentTheme === 1) {
            // === MODUS 1: TAG (ESRI TOPO - BLUE WATER) ===
            document.body.classList.add('day-mode');
            btn.innerText = "‚òÄÔ∏è";
            btn.style.background = "#fbbf24";
            btn.style.color = "#000";
            
            document.getElementById('turn-text').style.color = "#0f172a"; 
            
            // ESRI WORLD TOPO MAP (Land: Grau, Wasser: Blau)
            mapBaseLayer.setUrl('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}');
        
        } else {
            // === MODUS 2: NACHT (ROT) ===
            document.body.classList.add('night-mode');
            btn.innerText = "üî¥";
            btn.style.background = "#300";
            btn.style.color = "#f00";
            mapBaseLayer.setUrl('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
        }
    }

    function locateUser() { map.locate({setView: true, maxZoom: 15}); }
    
    function switchView(v, btn) {
        document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+v).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        btn.classList.add('active');
        if(v==='map') setTimeout(()=>map.invalidateSize(), 200);
    }
    
    // SAR Logic
    function handleSarClick() {
        if(sarRunning) {
            sarRunning = false; clearInterval(sarInt); routeLayer.clearLayers();
            document.getElementById('btn-sar-main').innerText = "SAR START";
            document.getElementById('btn-sar-main').style.background = "var(--alert)";
        } else {
            showSysMsg("Klicke jetzt auf die Karte, wo die Person zuletzt gesehen wurde.", "SAR EINSATZ");
            map.once('click', e => {
                sarPt = e.latlng;
                document.getElementById('sar-modal').style.display='block';
            });
        }
    }
    function startSar() {
        document.getElementById('sar-modal').style.display='none';
        const min = parseInt(document.getElementById('sar-min').value);
        sarRunning = true;
        sarStart = new Date(new Date().getTime() - min * 60000);
        document.getElementById('btn-sar-main').innerText = "BEENDEN";
        document.getElementById('btn-sar-main').style.background = "#333";
        updateSar();
        sarInt = setInterval(updateSar, 60000);
    }
    function updateSar() {
        const diff = Math.floor((new Date() - sarStart) / 60000);
        
        let shiftLat = 0;
        let shiftLng = 0;
        const driftFactor = 0.00005 * Math.abs(trendDiff); 
        
        if (trendDiff < 0) {
            // Ebb -> Drift West/North-West
            shiftLat = 0.0002 * diff; 
            shiftLng = -0.0005 * diff;
        } else {
             // Flood -> Drift East/South-East
            shiftLat = -0.0002 * diff;
            shiftLng = 0.0005 * diff;
        }
        
        const newLat = sarPt.lat + shiftLat;
        const newLng = sarPt.lng + shiftLng;
        const driftPos = L.latLng(newLat, newLng);

        routeLayer.clearLayers();
        
        L.circleMarker(sarPt, {color: 'red', radius: 3}).addTo(routeLayer);
        L.polyline([sarPt, driftPos], {color: 'yellow', dashArray: '5,5'}).addTo(routeLayer);

        const r = 50 + (diff * 10);
        L.circle(driftPos, {color: '#facc15', radius: r}).addTo(routeLayer)
         .bindPopup("SUCHGEBIET<br>Driftzeit: "+diff+" min").openPopup();
    }
    function closeModal() { document.getElementById('sar-modal').style.display='none'; }

    </script>
</body>
</html>
